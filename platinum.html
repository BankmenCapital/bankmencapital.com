<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bankmen Capital Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-base@0.9.27/lib/umd/index.min.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-wallets@0.19.27/lib/umd/index.min.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-react-ui@0.9.39/lib/umd/index.min.js"></script>
</head>
<body class="bg-[#0b0b12] text-white flex flex-col items-center justify-center h-screen font-sans">
  <!-- Locked screen -->
  <div id="locked" class="flex flex-col items-center">
    <h1 class="text-3xl font-bold mb-4">Bankmen Capital</h1>
    <p class="mb-6 text-gray-400 text-center max-w-sm">Access restricted to verified Bankmen NFT holders.</p>
    <button id="connectButton" class="bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded-lg font-semibold">Connect Wallet</button>
    <p id="status" class="text-red-400 mt-4"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden flex-col items-center w-full max-w-lg text-center">
    <h2 class="text-3xl font-bold mb-2">Welcome, Mogul</h2>
    <p class="text-gray-400 mb-8">Exclusive access granted to verified holders.</p>

    <div class="bg-[#151520] p-6 rounded-2xl shadow-xl w-full">
      <h3 class="text-xl mb-4 font-semibold">Your Dashboard</h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-[#1e1e2a] p-4 rounded-xl">
          <p class="text-sm text-gray-400">XP</p>
          <h4 class="text-2xl font-bold">0</h4>
        </div>
        <div class="bg-[#1e1e2a] p-4 rounded-xl">
          <p class="text-sm text-gray-400">Season</p>
          <h4 class="text-2xl font-bold">Coming Soon</h4>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <h3 class="text-xl mb-2 font-semibold">Your NFTs</h3>
      <div id="nftGrid" class="grid grid-cols-2 gap-3"></div>
    </div>
  </div>

  <script>
    const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
    const BANKMEN_COLLECTION = "GPtMdqNwNFnZGojyxEseXviJUZiqHyHDzWySjSHFup7J";

    const connectButton = document.getElementById('connectButton');
    const status = document.getElementById('status');
    const locked = document.getElementById('locked');
    const dashboard = document.getElementById('dashboard');
    const nftGrid = document.getElementById('nftGrid');

    async function connectWallet() {
      try {
        const provider = window.solana;
        if (!provider || !provider.isPhantom) {
          status.textContent = "Phantom wallet not found.";
          return;
        }

        const resp = await provider.connect();
        const walletAddress = resp.publicKey.toString();
        status.textContent = "Verifying ownership...";

        const hasNFT = await verifyOwnership(walletAddress);

        if (hasNFT) {
          locked.classList.add('hidden');
          dashboard.classList.remove('hidden');
          status.textContent = "";
          await loadNFTs(walletAddress);
        } else {
          status.textContent = "No Bankmen NFTs found.";
        }
      } catch (e) {
        console.error(e);
        status.textContent = "Connection or verification error.";
      }
    }

    async function verifyOwnership(walletAddress) {
      try {
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
          new solanaWeb3.PublicKey(walletAddress),
          { programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
        );

        for (const account of tokenAccounts.value) {
          const mint = account.account.data.parsed.info.mint;
          const metadataPDA = await getMetadataPDA(mint);
          const metadataAccountInfo = await connection.getAccountInfo(metadataPDA);
          if (metadataAccountInfo?.data) {
            const metadata = decodeMetadata(metadataAccountInfo.data);
            if (metadata.collection?.key === BANKMEN_COLLECTION && metadata.collection?.verified) {
              return true;
            }
          }
        }
        return false;
      } catch (err) {
        console.error(err);
        return false;
      }
    }

    async function loadNFTs(walletAddress) {
      nftGrid.innerHTML = `<p class="text-gray-400 text-sm col-span-2">Fetching your NFTs...</p>`;
      // Placeholder â€“ will replace with full metadata fetch later
      setTimeout(() => {
        nftGrid.innerHTML = `
          <div class="bg-[#1e1e2a] rounded-xl overflow-hidden"><img src="https://gateway.pinit.io/ipfs/QmdqV9BwhqqRymciXKu1SwJHNMNanosDpUk72aMjBP7e1q/2.png" class="w-full"></div>
        `;
      }, 1200);
    }

    async function getMetadataPDA(mint) {
      const [pda] = await solanaWeb3.PublicKey.findProgramAddress(
        [
          Buffer.from("metadata"),
          new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s").toBuffer(),
          new solanaWeb3.PublicKey(mint).toBuffer()
        ],
        new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s")
      );
      return pda;
    }

    function decodeMetadata(buffer) {
      const str = new TextDecoder("utf-8").decode(buffer);
      const jsonStart = str.indexOf("{");
      const jsonEnd = str.lastIndexOf("}") + 1;
      try { return JSON.parse(str.slice(jsonStart, jsonEnd)); }
      catch { return {}; }
    }

    connectButton.addEventListener('click', connectWallet);
  </script>
</body>
</html>
